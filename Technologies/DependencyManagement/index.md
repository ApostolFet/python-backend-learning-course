# Работа с зависимосями в Python

Документ посвящён необходимым знаниям, относящимся к работе с зависимостями в языке програмирования Python.

Для работы с зависимостями необходимо разобрать следующие темы: виртуальное окружение, прямые и транзитивные зависимости, группы зависимостей, инструменты (пакетные менеджеры)

## Виртуальное окружение

При установке сторонних библиотек глобально могут возникнуть проблемы: конфликты между разными проектами, сложно управлять зависимостями, а также можем случайно изменить системные зависимости, что может привести к сбою системы.
Для решения данных проблем и используется виртуальное окружения - каждое из которых, имеет собственные установленные библиотеки в специальной папке.
Рекомендуется практически всегда использовать виртуальное окружение для установки зависимостей.

В Python есть пакет для управления виртуальными зависимостями - venv (добавлен в версию 3.3), но также есть и сторонние инструменты - virtualenv, poetry

Что нужно знать, где почитать:

- Официальный туториал по созданию и работы с venv [creating-virtual-environments](https://docs.python.org/3/tutorial/venv.html#creating-virtual-environments)
- Туториал на ArchWiki - [https://wiki.archlinux.org/title/Python*(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)/Virtual_environment*(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)](<https://wiki.archlinux.org/title/Python_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)/Virtual_environment_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9)>)
- venv - [https://docs.python.org/3/library/venv.html](https://docs.python.org/3/library/venv.html)
- [Пост на эту тему](https://t.me/advice17/57)
- Практика - использование в проектах

## Прямые и транзитивные зависимости

Нужно разделять зависимости на два типа:

1.  логические (прямые) - те зависимости, которые мы ставим через pip <package_name> например: aiogram
2.  транзитивные - те зависимости, от которых зависит логические зависиости. (все зависимости aiogram, а также зависимости зависимостей aiogram и так далее)

Обычно мы хотим иметь отдельно список наших логических зависимостей и полный список зависимостей. Второй список полезен для воспроизводимых сборок нашего окружения. Первый список нам нужен для того, чтобы управлять логическими зависимостями, которые используются в нашем проекте, а также могут быть использованы для воостановления полного списка зависимостей.
Запись логических зависимостей можно вести в ручную: при установке библитеки вносить ее в список вместе с используемой версией (версии указываем). Этот процесс автоматизирован в некоторых пакетных менеджерах.

Почитать - [https://blog.ometer.com/2017/01/10/dear-package-managers-dependency-resolution-results-should-be-in-version-control/](https://blog.ometer.com/2017/01/10/dear-package-managers-dependency-resolution-results-should-be-in-version-control/)

## Группы зависимостей

Часто в проектах у нас есть зависимости, у которых есть разный сценарий использования:

1. Использования в продакшене
2. Использования при тестировнии
3. Использования при разработки
4. Использования для документации

Такие зависимости также часто нужно разделять, чтобы устанавливать только нужные зависимости

Почитать - [PEP 735](https://peps.python.org/pep-0735/)

## Пакетные менеджеры

В Python есть встроенный пакетный менеджер - pip. Он используется в реальных проектах, но большинство работы со списками (прямые/транзитвные, группы) приходятся брать на себя программисту.
Также есть сторонние решения, которые также часто используеются в реальных проектах:

1. [Poetry](https://python-poetry.org/) - Python packaging and dependency management made easy
   Одно из самых популярных решений на данный момент. Имеет фичи о которые были упомянуты выше:

   - Управление списками зависимостей (прямые/полный списко зависимостей с их версиями, группы)
   - Управление вирутуальным окружением
   - Управление сборкой и публикацией библиотек
   - и тд.

   Но также имеет свои недостатки - время разрешения зависимостей может быть долгой, нет каких-то специфичных фукнций

2. [uv](https://github.com/astral-sh/uv) - An extremely fast Python package installer and resolver, written in Rust.
   Интересный проект - ускоряет установку проектов.

3. [pip-tools](https://pip-tools.readthedocs.io/en/stable/) - Меньше ручной работы, чем в pip, но не такой богатый на функционал как poetry.

4. [Pipenv](https://docs.pipenv.org/en/latest/) - Python Dev Workflow for Humans
   Также используется для управлением зависимостей и виртуальным окружением.

В Python большой выбор пакетных менеджеров каждый из которых имеет свои плюсы и минусы.
В каждом конкретном случае лучший выбор будет зависисть от многих факторов и приоритетов в проекте.

## Полезные материалы

- https://pip.pypa.io/en/stable/
- https://pythonspeed.com/articles/pipenv-docker/
- https://pythonspeed.com/articles/poetry-vs-docker-caching/
- https://pythonspeed.com/articles/activate-virtualenv-dockerfile/
- https://ritza.co/articles/gen-articles/pipenv-vs-virtualenv-vs-poetry-vs-pyenv-vs-pip/
